"""
Estrategias de construcci√≥n de prompts para RAG BPG
Implementa patr√≥n Strategy para flexibilidad y mantenibilidad

Autor: Sistema RAG BPG
Versi√≥n: 2.0
"""

from abc import ABC, abstractmethod
from typing import Dict, Optional
from enum import Enum


class PromptType(Enum):
    """Tipos de estrategias de prompt disponibles"""
    STANDARD = "standard"
    CONCISE = "concise"
    FEWSHOT = "fewshot"
    TECHNICAL = "technical"


class BasePromptStrategy(ABC):
    """
    Clase base abstracta para estrategias de prompt
    Todas las estrategias deben heredar de esta clase
    """
    
    @abstractmethod
    def build(self, context: str, query: str, metadata: Optional[Dict] = None) -> str:
        """
        Construir prompt seg√∫n la estrategia
        
        Args:
            context: Contexto recuperado de los documentos
            query: Pregunta del usuario
            metadata: Informaci√≥n adicional opcional
            
        Returns:
            Prompt formateado
        """
        pass
    
    @property
    @abstractmethod
    def name(self) -> str:
        """Nombre descriptivo de la estrategia"""
        pass
    
    @property
    @abstractmethod
    def description(self) -> str:
        """Descripci√≥n de cu√°ndo usar esta estrategia"""
        pass
    
    @property
    @abstractmethod
    def max_tokens_recommended(self) -> int:
        """Tokens m√°ximos recomendados para esta estrategia"""
        pass


# ==================== ESTRATEGIA STANDARD ====================

class StandardPromptStrategy(BasePromptStrategy):
    """
    Estrategia est√°ndar optimizada para respuestas completas y precisas
    Usa: Para la mayor√≠a de consultas generales sobre BPG
    """
    
    @property
    def name(self) -> str:
        return "Standard"
    
    @property
    def description(self) -> str:
        return "Estrategia balanceada para respuestas completas y precisas"
    
    @property
    def max_tokens_recommended(self) -> int:
        return 500
    
    def build(self, context: str, query: str, metadata: Optional[Dict] = None) -> str:
        return f"""Sos un asesor t√©cnico especializado en Buenas Pr√°cticas Ganaderas (BPG) para productores argentinos de ganado vacuno.

CONTEXTO RELEVANTE DE LOS MANUALES:
---
{context}
---

CONSULTA DEL PRODUCTOR:
{query}

INSTRUCCIONES DE RESPUESTA:

1. AN√ÅLISIS PREVIO:
   - Revis√° si el contexto contiene informaci√≥n espec√≠fica para la consulta
   - Identific√° qu√© secciones del manual son relevantes

2. FORMATO DE RESPUESTA:
   - Comenz√° directo con la informaci√≥n pr√°ctica
   - Us√° vi√±etas (‚Ä¢) para listas o pasos
   - M√°ximo 300 palabras, prioriz√° lo esencial
   - Us√° lenguaje claro y directo (voseo argentino natural)

3. REGLAS ESTRICTAS:
   ‚úì Respond√© SOLO con datos del contexto proporcionado
   ‚úì Si hay requisitos normativos, mencion√° "seg√∫n normativa vigente"
   ‚úì Si hay n√∫meros/medidas espec√≠ficas, cit√° textualmente
   ‚úó NO inventes informaci√≥n que no est√© en el contexto
   ‚úó NO hagas suposiciones sobre pr√°cticas no mencionadas
   ‚úó NO des consejos que no est√©n respaldados por los manuales

4. SI LA INFO NO EST√Å EN EL CONTEXTO:
   Respond√©: "No encuentro esa informaci√≥n espec√≠fica en los manuales BPG que tengo disponibles. Te recomiendo consultar con un t√©cnico especializado o contactar a tu organismo de control local."

5. ESTRUCTURA IDEAL:
   - Respuesta directa (2-3 l√≠neas)
   - Detalles pr√°cticos en vi√±etas
   - Si aplica: requisito normativo o n√∫mero espec√≠fico
   - Opcional: contexto adicional relevante

RESPUESTA:"""


# ==================== ESTRATEGIA CONCISE ====================

class ConcisePromptStrategy(BasePromptStrategy):
    """
    Estrategia concisa para respuestas r√°pidas y directas
    Usa: Para consultas simples que requieren respuestas breves
    """
    
    @property
    def name(self) -> str:
        return "Concise"
    
    @property
    def description(self) -> str:
        return "Respuestas r√°pidas y directas al punto"
    
    @property
    def max_tokens_recommended(self) -> int:
        return 300
    
    def build(self, context: str, query: str, metadata: Optional[Dict] = None) -> str:
        return f"""Sos asesor en BPG para productores ganaderos argentinos.

INFORMACI√ìN DE LOS MANUALES:
{context}

PREGUNTA: {query}

REGLAS:
- Respond√© SOLO con info del contexto
- Us√° vi√±etas, m√°ximo 200 palabras
- Lenguaje claro y directo
- Si no est√° en el contexto: "No tengo esa info en los manuales"
- Cit√° n√∫meros exactamente como aparecen

RESPUESTA:"""


# ==================== ESTRATEGIA FEWSHOT ====================

class FewShotPromptStrategy(BasePromptStrategy):
    """
    Estrategia con ejemplos para mejorar calidad de respuestas
    Usa: Para consultas complejas donde se necesita mayor precisi√≥n
    """
    
    @property
    def name(self) -> str:
        return "Few-Shot"
    
    @property
    def description(self) -> str:
        return "Usa ejemplos para mejorar precisi√≥n en respuestas complejas"
    
    @property
    def max_tokens_recommended(self) -> int:
        return 600
    
    def build(self, context: str, query: str, metadata: Optional[Dict] = None) -> str:
        return f"""Sos asesor t√©cnico en Buenas Pr√°cticas Ganaderas para productores argentinos.

EJEMPLOS DE RESPUESTAS CORRECTAS:

Pregunta: "¬øQu√© pendiente debe tener la rampa de carga?"
Respuesta: "La rampa de carga debe tener:
- Pendiente suave con √°ngulo m√°ximo de 20¬∞ (25¬∞ si no se usa para terneros)
- Cuanto menor la pendiente, m√°s f√°cil cargar los animales
- Orientada para que el sol no est√© de frente al amanecer/atardecer
- Tramo final plano de m√°s de 2m
- Piso antideslizante (cemento ranurado o con pesta√±as)"

Pregunta: "¬øC√≥mo prevenir la mastitis en feedlot?"
Respuesta: "No encuentro informaci√≥n espec√≠fica sobre mastitis en estos manuales BPG de ganado de carne. Te recomiendo consultar con tu veterinario especializado."

---

INFORMACI√ìN DISPONIBLE:
{context}

CONSULTA ACTUAL: {query}

Respond√© siguiendo el estilo de los ejemplos. M√°ximo 300 palabras, lenguaje directo, vi√±etas para listas.

RESPUESTA:"""


# ==================== ESTRATEGIA TECHNICAL ====================

class TechnicalPromptStrategy(BasePromptStrategy):
    """
    Estrategia t√©cnica con enfoque en normativas y especificaciones
    Usa: Para consultas t√©cnicas detalladas o de cumplimiento normativo
    """
    
    @property
    def name(self) -> str:
        return "Technical"
    
    @property
    def description(self) -> str:
        return "Respuestas t√©cnicas detalladas con foco en normativas"
    
    @property
    def max_tokens_recommended(self) -> int:
        return 700
    
    def build(self, context: str, query: str, metadata: Optional[Dict] = None) -> str:
        return f"""Sos un consultor t√©cnico especializado en normativas y BPG para ganado vacuno en Argentina.

DOCUMENTACI√ìN T√âCNICA DISPONIBLE:
{context}

CONSULTA T√âCNICA:
{query}

FORMATO DE RESPUESTA T√âCNICA:

1. REQUISITOS NORMATIVOS:
   - Cit√° normativas espec√≠ficas si est√°n en el contexto
   - Indic√° "seg√∫n normativa vigente" cuando aplique
   - Destac√° requisitos obligatorios vs. recomendaciones

2. ESPECIFICACIONES T√âCNICAS:
   - Medidas exactas, porcentajes, valores num√©ricos
   - Rangos permitidos y tolerancias
   - Materiales y caracter√≠sticas espec√≠ficas

3. CRITERIOS DE CUMPLIMIENTO:
   - Qu√© se debe hacer
   - C√≥mo verificarlo
   - Cu√°ndo aplicarlo
   - Responsables

4. REFERENCIAS:
   - Si hay secciones espec√≠ficas del manual, mencion√° cu√°l
   - Identific√° la fuente (Feedlot, Transporte, etc.)

IMPORTANTE: 
- Si la informaci√≥n t√©cnica espec√≠fica no est√° en el contexto, indic√° claramente
- Suger√≠ qu√© tipo de profesional consultar (veterinario, ingeniero agr√≥nomo, etc.)
- No extrapoles ni supongas requisitos no mencionados

RESPUESTA T√âCNICA:"""


# ==================== FACTORY ====================

class PromptFactory:
    """
    Factory para crear y gestionar estrategias de prompt
    Implementa patr√≥n Factory para creaci√≥n centralizada
    """
    
    # Registro de estrategias disponibles
    _strategies = {
        PromptType.STANDARD: StandardPromptStrategy(),
        PromptType.CONCISE: ConcisePromptStrategy(),
        PromptType.FEWSHOT: FewShotPromptStrategy(),
        PromptType.TECHNICAL: TechnicalPromptStrategy(),
    }
    
    @classmethod
    def get_strategy(cls, prompt_type: PromptType) -> BasePromptStrategy:
        """
        Obtener estrategia de prompt por tipo
        
        Args:
            prompt_type: Tipo de estrategia deseada
            
        Returns:
            Instancia de la estrategia
            
        Raises:
            ValueError: Si el tipo no existe
        """
        strategy = cls._strategies.get(prompt_type)
        if strategy is None:
            raise ValueError(f"Estrategia '{prompt_type}' no encontrada")
        return strategy
    
    @classmethod
    def get_strategy_by_name(cls, name: str) -> BasePromptStrategy:
        """
        Obtener estrategia por nombre (string)
        
        Args:
            name: Nombre de la estrategia ("standard", "concise", etc.)
            
        Returns:
            Instancia de la estrategia
        """
        try:
            prompt_type = PromptType(name.lower())
            return cls.get_strategy(prompt_type)
        except ValueError:
            # Si no existe, devolver standard por defecto
            print(f"‚ö†Ô∏è  Estrategia '{name}' no encontrada, usando 'standard'")
            return cls.get_strategy(PromptType.STANDARD)
    
    @classmethod
    def list_strategies(cls) -> Dict[str, str]:
        """
        Listar todas las estrategias disponibles con sus descripciones
        
        Returns:
            Dict con nombre -> descripci√≥n
        """
        return {
            pt.value: cls._strategies[pt].description
            for pt in PromptType
        }
    
    @classmethod
    def print_strategies(cls):
        """Imprimir estrategias disponibles de forma legible"""
        print("\n" + "="*60)
        print("üìù ESTRATEGIAS DE PROMPT DISPONIBLES")
        print("="*60)
        
        for pt in PromptType:
            strategy = cls._strategies[pt]
            print(f"\nüîπ {strategy.name.upper()} ({pt.value})")
            print(f"   {strategy.description}")
            print(f"   Max tokens recomendados: {strategy.max_tokens_recommended}")
        
        print("="*60 + "\n")